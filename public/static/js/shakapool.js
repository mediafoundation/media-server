require=function e(t,s,r){function i(a,o){if(!s[a]){if(!t[a]){var d="function"==typeof require&&require;if(!o&&d)return d(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var g=s[a]={exports:{}};t[a][0].call(g.exports,(function(e){return i(t[a][1][e]||e)}),g,g.exports,e,t,s,r)}return s[a].exports}for(var n="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t};Object.defineProperty(s,"__esModule",{value:!0});const a=n(e("./index"));window.p2pml||(window.p2pml={}),window.p2pml.shaka=a},{"./index":"p2p-media-loader-shaka"}],2:[function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t};Object.defineProperty(s,"__esModule",{value:!0}),s.Engine=void 0;const a=e("events"),o=e("p2p-media-loader-core"),d=e("./segment-manager"),h=n(e("./integration"));class g extends a.EventEmitter{constructor(e={}){super(),this.loader=new o.HybridLoader(e.loader),this.segmentManager=new d.SegmentManager(this.loader,e.segments),Object.keys(o.Events).map((e=>o.Events[e])).forEach((e=>this.loader.on(e,((...t)=>this.emit(e,...t)))))}static isSupported(){return o.HybridLoader.isSupported()}async destroy(){await this.segmentManager.destroy()}getSettings(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}getDetails(){return{loader:this.loader.getDetails()}}initShakaPlayer(e){h.initShakaPlayer(e,this.segmentManager)}}s.Engine=g},{"./integration":3,"./segment-manager":6,events:"events","p2p-media-loader-core":"p2p-media-loader-core"}],3:[function(e,t,s){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(s,"__esModule",{value:!0}),s.initShakaPlayer=void 0;const i=r(e("debug")),n=e("./manifest-parser-proxy"),a=e("./utils"),o=i.default("p2pml:shaka:index");function d(e,t,s,r){var i,n,d,g;const u=shaka.net.HttpXHRPlugin.parse?shaka.net.HttpXHRPlugin.parse:shaka.net.HttpXHRPlugin,{p2pml:l}=t;if(!l)return u(e,t,s,r);const{player:c,segmentManager:m}=l;let f,p=m.getSettings().assetsStorage;const y=c.getNetworkingEngine(),v=null===(i=null==y?void 0:y.p2pml)||void 0===i?void 0:i.masterManifestUri;let S;p&&v?f=a.getMasterSwarmId(v,m.getSettings()):p=void 0;const P=c.getManifest();if(s===shaka.net.NetworkingEngine.RequestType.SEGMENT&&(S=null===(d=null===(n=null==P?void 0:P.p2pml)||void 0===n?void 0:n.parser)||void 0===d?void 0:d.find(e,null===(g=t.headers)||void 0===g?void 0:g.Range)),void 0!==S&&"video"===S.streamType){o("request","load",S.identity);const e=m.load(S,a.getSchemedUri(c.getAssetUri?c.getAssetUri():c.getManifestUri()),h(c)),t=async()=>{o("request","abort",S.identity)};return new shaka.util.AbortableOperation(e,t)}if(p&&f&&v){const i=(async()=>{var i,n;const a=await p.getAsset(e,null===(i=t.headers)||void 0===i?void 0:i.Range,f);if(void 0!==a)return{data:a.data,uri:a.responseUri,originalUri:a.requestUri,fromCache:!0,headers:{}};{const i=await u(e,t,s,r).promise;return p.storeAsset({masterManifestUri:v,masterSwarmId:f,requestUri:e,requestRange:null===(n=t.headers)||void 0===n?void 0:n.Range,responseUri:i.uri,data:i.data}),i}})();return new shaka.util.AbortableOperation(i,(async()=>{}))}return u(e,t,s,r)}function h(e){let t=0;const s=e.getPlayheadTimeAsDate();return s&&(t=s.valueOf(),e.isLive()&&(t-=e.getPresentationStartTimeAsDate().valueOf()),t/=1e3),t}s.initShakaPlayer=function(e,t){let s;o("register parser proxies"),shaka.media.ManifestParser.registerParserByExtension("mpd",n.ShakaDashManifestParserProxy),shaka.media.ManifestParser.registerParserByMime("application/dash+xml",n.ShakaDashManifestParserProxy),shaka.media.ManifestParser.registerParserByExtension("m3u8",n.ShakaHlsManifestParserProxy),shaka.media.ManifestParser.registerParserByMime("application/x-mpegurl",n.ShakaHlsManifestParserProxy),shaka.media.ManifestParser.registerParserByMime("application/vnd.apple.mpegurl",n.ShakaHlsManifestParserProxy),o("init networking engine"),shaka.net.NetworkingEngine.registerScheme("http",d),shaka.net.NetworkingEngine.registerScheme("https",d);let r=0;e.addEventListener("loading",(()=>{(async()=>{s&&(clearInterval(s),s=void 0),r=0;const i=e.getManifest();i&&i.p2pml&&i.p2pml.parser.reset(),await t.destroy(),s=setInterval((()=>{const s=h(e);(s!==r||e.isBuffering())&&(t.setPlayheadTime(s),r=s)}),500)})()})),o("register request filter"),e.getNetworkingEngine().registerRequestFilter(((s,r)=>{r.p2pml={player:e,segmentManager:t}}))}},{"./manifest-parser-proxy":4,"./utils":7,debug:"debug"}],4:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.ShakaHlsManifestParserProxy=s.ShakaDashManifestParserProxy=s.ShakaManifestParserProxy=void 0;const r=e("./parser-segment");class i{constructor(e){this.cache=new r.ParserSegmentCache(200),this.getPosition=e=>this.isHls()&&"video"===e.type?this.manifest.periods[0].variants.reduce(((e,t)=>(t.video&&t.video.id&&!e.includes(t.video.id)&&e.push(t.video.id),e)),[]).indexOf(e.id):-1,this.originalManifestParser=e}isHls(){return this.originalManifestParser instanceof shaka.hls.HlsParser}isDash(){return this.originalManifestParser instanceof shaka.dash.DashParser}async start(e,t){t.networkingEngine.p2pml={masterManifestUri:e},this.manifest=await this.originalManifestParser.start(e,t);for(const e of this.manifest.periods){const t=[];for(const s of e.variants)null!==s.video&&-1===t.indexOf(s.video)&&(s.video.getSegmentReference?this.hookGetSegmentReference(s.video):this.hookSegmentIndex(s.video),t.push(s.video)),null!==s.audio&&-1===t.indexOf(s.audio)&&(s.audio.getSegmentReference?this.hookGetSegmentReference(s.audio):this.hookSegmentIndex(s.audio),t.push(s.audio))}return this.manifest.p2pml={parser:this},this.manifest}configure(e){return this.originalManifestParser.configure(e)}stop(){return this.originalManifestParser.stop()}update(){return this.originalManifestParser.update()}onExpirationUpdated(e,t){return this.originalManifestParser.onExpirationUpdated(e,t)}find(e,t){return this.cache.find(e,t)}reset(){this.cache.clear()}hookGetSegmentReference(e){e.getSegmentReferenceOriginal=e.getSegmentReference,e.getSegmentReference=t=>{const s=e.getSegmentReferenceOriginal(t);return this.cache.add(e,s),s},e.getPosition=()=>this.getPosition(e)}hookSegmentIndex(e){e.createSegmentIndexOriginal=e.createSegmentIndex,e.createSegmentIndex=async()=>{const t=await e.createSegmentIndexOriginal(),s=e.segmentIndex.get;return e.getSegmentReferenceOriginal=t=>s.call(e.segmentIndex,t),e.segmentIndex.get=t=>{const s=e.getSegmentReferenceOriginal(t);return this.cache.add(e,s),s},t},e.getPosition=()=>this.getPosition(e)}}s.ShakaManifestParserProxy=i;s.ShakaDashManifestParserProxy=class extends i{constructor(){super(new shaka.dash.DashParser)}};s.ShakaHlsManifestParserProxy=class extends i{constructor(){super(new shaka.hls.HlsParser)}}},{"./parser-segment":5}],5:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.ParserSegmentCache=s.ParserSegment=void 0;const r=e("./utils");class i{constructor(e,t,s,r,i,n,a,o,d,h,g){this.streamId=e,this.streamType=t,this.streamPosition=s,this.streamIdentity=r,this.identity=i,this.position=n,this.start=a,this.end=o,this.uri=d,this.range=h,this.next=g}static create(e,t){if(!t)return;const s=t.createUris();if(!s||0===s.length)return;const n=t.getStartTime(),a=t.getEndTime(),o=t.getStartByte(),d=t.getEndByte(),h=o||d?`bytes=${o||""}-${d||""}`:void 0,g=e.type.substring(0,1).toUpperCase(),u=e.getPosition(),l=u>=0,c=l?`${g}${u}`:`${g}${e.id}`,m=l?`${t.getPosition()}`:`${Number(n).toFixed(3)}`;return new i(e.id,e.type,u,c,m,t.getPosition(),n,a,r.getSchemedUri(s[0]),h,(()=>i.create(e,e.getSegmentReferenceOriginal(t.getPosition()-1))))}}s.ParserSegment=i;s.ParserSegmentCache=class{constructor(e){this.segments=[],this.maxSegments=e}find(e,t){return this.segments.find((s=>s.uri===e&&s.range===t))}add(e,t){const s=i.create(e,t);s&&!this.find(s.uri,s.range)&&(this.segments.push(s),this.segments.length>this.maxSegments&&this.segments.splice(0,.2*this.maxSegments))}clear(){this.segments.splice(0)}}},{"./utils":7}],6:[function(e,t,s){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(s,"__esModule",{value:!0}),s.SegmentManager=void 0;const i=r(e("debug")),n=e("p2p-media-loader-core"),a=e("./utils"),o={forwardSegmentCount:20,maxHistorySegments:50,swarmId:void 0,assetsStorage:void 0};s.SegmentManager=class{constructor(e,t={}){this.debug=i.default("p2pml:shaka:sm"),this.requests=new Map,this.manifestUri="",this.playheadTime=0,this.segmentHistory=[],this.onSegmentLoaded=e=>{this.requests.has(e.id)&&(this.reportSuccess(this.requests.get(e.id),e),this.debug("request delete",e.id),this.requests.delete(e.id))},this.onSegmentError=(e,t)=>{this.requests.has(e.id)&&(this.reportError(this.requests.get(e.id),t),this.debug("request delete from error",e.id),this.requests.delete(e.id))},this.onSegmentAbort=e=>{this.requests.has(e.id)&&(this.reportError(this.requests.get(e.id),"Internal abort"),this.debug("request delete from abort",e.id),this.requests.delete(e.id))},this.settings=Object.assign(Object.assign({},o),t),this.loader=e,this.loader.on(n.Events.SegmentLoaded,this.onSegmentLoaded),this.loader.on(n.Events.SegmentError,this.onSegmentError),this.loader.on(n.Events.SegmentAbort,this.onSegmentAbort)}async destroy(){if(0!==this.requests.size){console.error("Destroying segment manager with active request(s)!");for(const e of this.requests.values())this.reportError(e,"Request aborted due to destroy call");this.requests.clear()}this.playheadTime=0,this.segmentHistory.splice(0),void 0!==this.settings.assetsStorage&&await this.settings.assetsStorage.destroy(),await this.loader.destroy()}getSettings(){return this.settings}async load(e,t,s){this.manifestUri=t,this.playheadTime=s,this.pushSegmentHistory(e);const r=this.refreshLoad(),i=await this.loader.getSegment(r.id);return new Promise(((e,t)=>{const s=new d(r.id,e,t);i?this.reportSuccess(s,i):(this.debug("request add",s.id),this.requests.set(s.id,s))}))}setPlayheadTime(e){this.playheadTime=e,this.segmentHistory.length>0&&this.refreshLoad()}refreshLoad(){const e=this.segmentHistory[this.segmentHistory.length-1],t=this.playheadTime>.1?this.playheadTime:e.start,s=this.segmentHistory.reduce(((e,s)=>(s.start>=t&&e.push(s),e)),[]);0===s.length&&s.push(e);const r=s.length-1;do{const e=s[s.length-1].next();if(!e)break;s.push(e)}while(s.length<this.settings.forwardSegmentCount);const i=a.getMasterSwarmId(this.manifestUri,this.settings),n=s.map(((e,t)=>({id:`${i}+${e.streamIdentity}+${e.identity}`,url:e.uri,masterSwarmId:i,masterManifestUri:this.manifestUri,streamId:e.streamIdentity,sequence:e.identity,range:e.range,priority:t})));return this.loader.load(n,`${i}+${e.streamIdentity}`),n[r]}pushSegmentHistory(e){this.segmentHistory.length>=this.settings.maxHistorySegments&&(this.debug("segment history auto shrink"),this.segmentHistory.splice(0,.2*this.settings.maxHistorySegments)),this.segmentHistory.length>0&&this.segmentHistory[this.segmentHistory.length-1].start>e.start&&(this.debug("segment history reset due to playhead seek back"),this.segmentHistory.splice(0)),this.segmentHistory.push(e)}reportSuccess(e,t){let s;void 0!==t.downloadBandwidth&&t.downloadBandwidth>0&&t.data&&t.data.byteLength>0&&(s=Math.trunc(t.data.byteLength/t.downloadBandwidth)),this.debug("report success",e.id),e.resolve({data:t.data,timeMs:s,headers:{},originalUri:t.requestUrl,uri:t.requestUrl})}reportError(e,t){e.reject&&(this.debug("report error",e.id),e.reject(t))}};class d{constructor(e,t,s){this.id=e,this.resolve=t,this.reject=s}}},{"./utils":7,debug:"debug","p2p-media-loader-core":"p2p-media-loader-core"}],7:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.getMasterSwarmId=s.getSchemedUri=void 0,s.getSchemedUri=function(e){return e.startsWith("//")?window.location.protocol+e:e},s.getMasterSwarmId=function(e,t){return t.swarmId&&0!==t.swarmId.length?t.swarmId:e.split("?")[0]}},{}],"p2p-media-loader-shaka":[function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(s,"__esModule",{value:!0}),s.version=void 0,s.version="0.6.2",i(e("./engine"),s),i(e("./segment-manager"),s)},{"./engine":2,"./segment-manager":6}]},{},[1]);
